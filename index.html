<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank Card Maker</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Cropper CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="logo.png">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Prompt', sans-serif;
            background: #f4f6f8;
            margin: 0; padding: 20px 15px;
            display: flex; justify-content: center;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%; max-width: 420px;
            background: transparent;
        }

        /* Header */
        .app-header {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px;
        }
        .app-title { font-size: 22px; font-weight: 700; color: #2c3e50; margin: 0; }

        /* --- CARD PREVIEW AREA --- */
        .card-preview-container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .slip-wrapper {
            background-color: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Card Header */
        .card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; height: 60px;
        }
        .bank-logo-group { display: flex; align-items: center; gap: 12px; }
        .bank-logo-img { width: 50px; height: 50px; object-fit: contain; border-radius: 50%; }
        .bank-info h1 { margin: 0; font-size: 22px; font-weight: 800; line-height: 1; letter-spacing: -0.5px; }
        .bank-info p { margin: 3px 0 0 0; font-size: 11px; color: #888; font-weight: 600; font-family: 'Sarabun', sans-serif; }
        
        .qr-box {
            width: 60px; height: 60px; border: 1px dashed #ccc; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #aaa; background: #fafafa;
            overflow: hidden; position: relative; cursor: pointer;
        }
        .qr-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .qr-box i { font-size: 20px; margin-bottom: 2px; }
        .qr-placeholder { display: flex; flex-direction: column; align-items: center; pointer-events: none;}

        /* Card Body */
        .card-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        .card-label {
            padding: 4px 8px; border-radius: 4px; color: white;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            flex-shrink: 0;
        }
        .card-number { font-size: 22px; font-weight: 700; color: #444; letter-spacing: 0.5px; font-family: 'Sarabun', sans-serif; }
        
        .card-name-bar {
            padding: 10px; text-align: center; color: white;
            font-size: 16px; font-weight: 700; text-transform: uppercase;
            border-radius: 6px; width: 100%;
        }

        /* --- CONTROLS SECTION --- */
        .section-title {
            font-size: 14px; font-weight: 600; color: #7f8c8d;
            margin-bottom: 15px; display: block;
        }
        /* Compact Title for Input Section */
        .input-section-title {
            font-size: 14px; font-weight: 600; color: #7f8c8d;
            margin-bottom: 5px; display: block; /* Reduced Margin */
        }

        /* Download Button */
        .download-btn {
            width: 100%; padding: 16px;
            background: #6c5ce7; color: white;
            border: none; border-radius: 50px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        .download-btn:active { transform: scale(0.98); }
        .fb-hint { font-size: 11px; color: #999; text-align: center; margin-bottom: 30px; line-height: 1.4; }

        /* Bank Grid */
        .bank-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            margin-bottom: 30px;
        }
        .bank-item {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            cursor: pointer; opacity: 0.6; transition: 0.3s;
        }
        .bank-item.active { opacity: 1; transform: translateY(-5px); }
        .bank-icon {
            width: 50px; height: 50px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-size: 24px; font-weight: bold; overflow: hidden;
            border: 2px solid transparent;
        }
        .bank-item.active .bank-icon { border-color: currentColor; }
        .bank-item span { font-size: 11px; font-weight: 600; color: #555; }
        
        .bank-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* Inputs with Icons */
        .input-group { margin-bottom: 12px; position: relative; }
        .input-icon {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            color: #888; font-size: 16px; z-index: 2;
        }
        .input-box {
            width: 100%; padding: 14px 15px 14px 45px; /* Padding Left for Icon */
            border: 1px solid #e0e0e0; border-radius: 12px;
            font-size: 15px; background: white;
            font-family: 'Sarabun', sans-serif;
            transition: 0.3s;
        }
        .input-box:focus { border-color: #6c5ce7; box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1); }

        /* Modals */
        .crop-modal-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 5000; backdrop-filter: blur(5px); }
        .crop-modal-content, .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.3s; }
        .crop-container { width: 100%; height: 300px; margin-bottom: 20px; background: #f0f0f0; overflow: hidden; border-radius: 8px; }
        .crop-container img { max-width: 100%; }
        .crop-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-crop { background: #00a950; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-cancel { background: #e0e0e0; color: #333; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; }
        .fb-btn-back { background: #f1f2f6; color: #555; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .fb-btn-continue { background: #1877f2; color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Upload Button */
        .upload-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- Header -->
        <div class="app-header">
            <h1 class="app-title">Bank Card Maker</h1>
        </div>

        <!-- 1. Card Preview -->
        <div class="card-preview-container">
            <div class="slip-wrapper" id="card-canvas">
                <div class="card-header">
                    <div class="bank-logo-group">
                        <img src="logo.png" class="bank-logo-img" id="display-logo">
                        <div class="bank-info">
                            <h1 id="display-bank-name">KBANK</h1>
                            <p id="display-sub-name">ธนาคารกสิกรไทย</p>
                        </div>
                    </div>
                    <div class="qr-box">
                        <div class="qr-placeholder" id="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <span>QR</span>
                        </div>
                        <img id="display-qr" src="">
                        <input type="file" class="upload-btn" accept="image/*" onchange="handleQR(this)">
                    </div>
                </div>

                <div class="card-row">
                    <div class="card-label" id="display-label">BANK NUMBER</div>
                    <div class="card-number" id="display-num">000-000-0000</div>
                </div>

                <div class="card-name-bar" id="display-name">
                    NAME HERE
                </div>
            </div>
        </div>

        <!-- 2. Action -->
        <button class="download-btn" onclick="download()">
            <i class="fas fa-download"></i> ပုံသိမ်းမည် (Download)
        </button>
        <div class="fb-hint">
            Facebook Browser တွင် Download မရပါက ညာဘက်အပေါ်ထောင့် (...) နှိပ်ပြီး "Open in Chrome" ဖြင့်ဖွင့်ပါ
        </div>

        <!-- 3. Bank Selector -->
        <span class="section-title">ဘဏ် ရွေးချယ်ရန် (Bank)</span>
        <div class="bank-grid">
            <!-- K-Bank (Active by default) -->
            <div class="bank-item active" onclick="selectBank('kbank')">
                <div class="bank-icon" style="color: #00a950;"><img src="kbank.png" onerror="this.src='logo.png'"></div>
                <span>KBANK</span>
            </div>
            <!-- SCB -->
            <div class="bank-item" onclick="selectBank('scb')">
                <div class="bank-icon" style="color: #4e2a84;"><img src="scb.png" onerror="this.src='scb-logo.png'"></div>
                <span>SCB</span>
            </div>
            <!-- BBL -->
            <div class="bank-item" onclick="selectBank('bbl')">
                <div class="bank-icon" style="color: #1e3a8a;"><img src="bbl.png" onerror="this.src='bbl-logo.png'"></div>
                <span>BBL</span>
            </div>
            <!-- KTB -->
            <div class="bank-item" onclick="selectBank('ktb')">
                <div class="bank-icon" style="color: #00a5e5;"><img src="ktb.png" onerror="this.src='ktb-logo.png'"></div>
                <span>KTB</span>
            </div>
            <!-- BAY -->
            <div class="bank-item" onclick="selectBank('bay')">
                <div class="bank-icon" style="color: #fec42d;"><img src="bay.png" onerror="this.src='krungsri-logo.png'"></div>
                <span>BAY</span>
            </div>
            <!-- TTB -->
            <div class="bank-item" onclick="selectBank('ttb')">
                <div class="bank-icon" style="color: #00569a;"><img src="ttb.png" onerror="this.src='ttb-logo.png'"></div>
                <span>TTB</span>
            </div>
        </div>

        <!-- 4. Inputs (Icons Added + Tight Spacing) -->
        <span class="input-section-title">အချက်အလက်များ</span>
        
        <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input type="text" class="input-box" id="in-name" placeholder="အမည် (Name)" oninput="update()">
        </div>
        <div class="input-group">
            <i class="fas fa-credit-card input-icon"></i>
            <input type="tel" class="input-box" id="in-num" placeholder="အကောင့်နံပါတ် (000-000-0000)" maxlength="12" oninput="formatNum(this)">
        </div>

    </div>

    <!-- CROP MODAL -->
    <div class="crop-modal-overlay" id="cropModal">
        <div class="crop-modal-content">
            <h3 style="margin-top:0;">Crop QR Code</h3>
            <div class="crop-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="crop-actions">
                <button class="btn-cancel" onclick="closeCropModal()">မလုပ်တော့ပါ</button>
                <button class="btn-crop" onclick="cropImage()">ဖြတ်မည် (Crop)</button>
            </div>
        </div>
    </div>

    <!-- FB Warning Modal -->
    <div class="modal-overlay" id="fbModal">
        <div class="modal-content">
            <h3 style="color:#1877f2; margin-top:0;"><i class="fab fa-facebook"></i> Browser Warning</h3>
            <p style="font-size:14px; opacity:0.8;">Facebook App အတွင်း Download မရနိုင်ပါ။ Chrome တွင်ဖွင့်ရန် ကြိုးစားပေးပါမည်။</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="fb-btn-back" onclick="closeFbModal()">BACK</button>
                <button class="fb-btn-continue" onclick="forceOpenChrome()">CONTINUE</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        // --- Bank Data ---
        const banks = {
            kbank: {
                name: 'KBANK', sub: 'ธนาคารกสิกรไทย', logo: 'logo.png',
                color: '#00a950', gradient: 'linear-gradient(90deg, #00a950 0%, #007a37 100%)',
                labelColor: '#00a950', labelText: 'BANK NUMBER'
            },
            scb: {
                name: 'SCB', sub: 'ไทยพาณิชย์', logo: 'scb-logo.png',
                color: '#4e2a84', gradient: 'linear-gradient(90deg, #4e2a84 0%, #7d4198 100%)',
                labelColor: '#4e2a84', labelText: 'SCB EASY'
            },
            bbl: {
                name: 'BBL', sub: 'ธนาคารกรุงเทพ', logo: 'bbl-logo.png',
                color: '#1e3a8a', gradient: 'linear-gradient(90deg, #1e3a8a 0%, #1565c0 100%)',
                labelColor: '#1e3a8a', labelText: 'BANK NUMBER'
            },
            ktb: {
                name: 'KTB', sub: 'ธนาคารกรุงไทย', logo: 'ktb-logo.png',
                color: '#00a5e5', gradient: 'linear-gradient(90deg, #00a5e5 0%, #008dc9 100%)',
                labelColor: '#00a5e5', labelText: 'Krungthai'
            },
            bay: {
                name: 'BAY', sub: 'ธนาคารกรุงศรีอยุธยา', logo: 'krungsri-logo.png',
                color: '#fec42d', gradient: 'linear-gradient(90deg, #fec42d 0%, #f57f17 100%)',
                labelColor: '#fec42d', labelText: 'KRUNGSRI'
            },
            ttb: {
                name: 'ttb', sub: 'ธนาคารทหารไทยธนชาต', logo: 'ttb-logo.png',
                color: '#00569a', gradient: 'linear-gradient(90deg, #00569a 0%, #f37021 100%)',
                labelColor: '#00569a', labelText: 'ttb touch'
            }
        };

        let currentBank = 'kbank';
        let cropper;

        // --- Init ---
        window.onload = function() {
            // 1. Set K-Bank as Default IMMEDIATELY
            selectBank('kbank');
            
            // 2. Check for Auto-Download
            const params = new URLSearchParams(window.location.search);
            const nameParam = params.get('name');
            const numParam = params.get('num');
            const autoParam = params.get('auto');

            if (nameParam) {
                document.getElementById('in-name').value = decodeURIComponent(nameParam);
                update();
            }
            if (numParam) {
                document.getElementById('in-num').value = decodeURIComponent(numParam);
                formatNum(document.getElementById('in-num'));
            }

            if (autoParam === 'true') {
                setTimeout(() => {
                    generateAndDownload();
                    // Clean URL
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }, 1000); 
            }
        };

        function selectBank(bankKey) {
            currentBank = bankKey;
            const config = banks[bankKey];
            
            document.querySelectorAll('.bank-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.bank-item[onclick="selectBank('${bankKey}')"]`).classList.add('active');

            document.getElementById('display-bank-name').innerText = config.name;
            document.getElementById('display-bank-name').style.color = config.color;
            document.getElementById('display-sub-name').innerText = config.sub;
            
            const logoEl = document.getElementById('display-logo');
            logoEl.src = config.logo;
            logoEl.onerror = function() { 
                if(this.src.includes('kbank.png')) this.src = 'logo.png';
                else if(this.src.includes('scb.png')) this.src = 'scb-logo.png';
                else if(this.src.includes('bbl.png')) this.src = 'bbl-logo.png';
                else if(this.src.includes('ktb.png')) this.src = 'ktb-logo.png';
                else if(this.src.includes('bay.png')) this.src = 'krungsri-logo.png';
                else if(this.src.includes('ttb.png')) this.src = 'ttb-logo.png';
            };

            document.getElementById('display-label').innerText = config.labelText;
            document.getElementById('display-label').style.background = config.color;
            document.getElementById('display-name').style.background = config.gradient;
            
            if(bankKey === 'bay') {
                document.getElementById('display-label').style.color = '#4e3b31';
                document.getElementById('display-name').style.color = '#4e3b31';
            } else {
                document.getElementById('display-label').style.color = 'white';
                document.getElementById('display-name').style.color = 'white';
            }
        }

        function handleQR(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('image-to-crop').src = e.target.result;
                    document.getElementById('cropModal').style.display = 'flex';
                    if (cropper) cropper.destroy();
                    const image = document.getElementById('image-to-crop');
                    cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = ''; 
        }

        function cropImage() {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
                const croppedDataUrl = canvas.toDataURL();
                document.getElementById('display-qr').src = croppedDataUrl;
                document.getElementById('display-qr').style.display = 'block';
                document.getElementById('qr-placeholder').style.display = 'none';
                closeCropModal();
            }
        }

        function closeCropModal() {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) cropper.destroy();
        }

        function update() {
            let val = document.getElementById('in-name').value;
            document.getElementById('display-name').innerText = val ? val.toUpperCase() : "NAME HERE";
        }

        function formatNum(input) {
            let val = input.value.replace(/\D/g, '');
            let formatted = val;
            if (val.length > 6) formatted = val.substring(0, 3) + '-' + val.substring(3, 6) + '-' + val.substring(6, 10);
            else if (val.length > 3) formatted = val.substring(0, 3) + '-' + val.substring(3, 6);
            input.value = formatted;
            document.getElementById('display-num').innerText = formatted || "000-000-0000";
        }

        function download() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isFacebook = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1);

            if (isFacebook) {
                const nameVal = document.getElementById('in-name').value;
                const numVal = document.getElementById('in-num').value;
                const baseUrl = window.location.href.split('?')[0];
                const targetUrl = `${baseUrl}?name=${encodeURIComponent(nameVal)}&num=${encodeURIComponent(numVal)}&auto=true`;
                const cleanTarget = targetUrl.replace(/^https?:\/\//, '');
                const intentUrl = `intent://${cleanTarget}#Intent;scheme=https;package=com.android.chrome;end`;
                window.location.href = intentUrl;
                document.getElementById('fbModal').style.display = 'flex';
                return;
            }
            generateAndDownload();
        }

        function generateAndDownload() {
            const el = document.getElementById('card-canvas');
            const originalRadius = el.style.borderRadius;
            el.style.borderRadius = '0'; 
            html2canvas(el, { scale: 3, backgroundColor: "#ffffff" }).then(canvas => {
                el.style.borderRadius = originalRadius; 
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = currentBank + '-card.png';
                    link.href = url; document.body.appendChild(link); link.click();
                    document.body.removeChild(link); URL.revokeObjectURL(url);
                }, 'image/png');
            });
        }

        function forceOpenChrome() {
            const currentUrl = window.location.href.replace(/^https?:\/\//, '');
            const intentUrl = `intent://${currentUrl}#Intent;scheme=https;package=com.android.chrome;end`;
            window.location.href = intentUrl;
        }

        function closeFbModal() { document.getElementById('fbModal').style.display = 'none'; }
    </script>
</body>
</html>


